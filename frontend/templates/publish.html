<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布账号 - 游戏账号租赁平台</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .region-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .region-btn.active {
            background: linear-gradient(135deg, #1e90ff 0%, #00bfff 100%);
            color: white;
            border-color: #1e90ff;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">游戏账号租赁平台</a>
            <ul class="navbar-menu">
                <li><a href="/rental">账号租赁</a></li>
                <li><a href="/publish">发布账号</a></li>
                <li><a href="/activity">出币活动</a></li>
                <li><a href="/profile">个人中心</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>
    
    <!-- 主内容 -->
    <div class="container">
        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <h2 class="card-title">发布账号</h2>
            
            <form id="publishForm">
                <!-- 账号编号由系统自动生成，不需要手动填写 -->
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">收号时间</label>
                        <input type="text" class="form-control" id="collectionTime" placeholder="例如：12月1日">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">上号时间</label>
                        <input type="text" class="form-control" id="loginTime" placeholder="例如：8:00-22:00">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">常用地</label>
                        <input type="text" class="form-control" id="commonLocation" placeholder="例如：上海">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">区服 *</label>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="region-btn" id="qqBtn" onclick="selectRegion('qq')" style="flex: 1;">QQ</button>
                            <button type="button" class="region-btn" id="wechatBtn" onclick="selectRegion('wechat')" style="flex: 1;">微信</button>
                        </div>
                        <input type="hidden" id="serverRegion">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">登录方式</label>
                        <select class="form-control" id="loginMethod">
                            <option value="">请选择</option>
                            <option value="账密登录">账密登录</option>
                            <option value="扫码登录">扫码登录</option>
                            <option value="账密/扫码">账密/扫码</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">人脸认证</label>
                        <select class="form-control" id="faceVerification">
                            <option value="">请选择</option>
                            <option value="已认证">已认证</option>
                            <option value="未认证">未认证</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">段位</label>
                        <input type="text" class="form-control" id="rank" placeholder="例如：钻石">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">等级</label>
                        <input type="number" class="form-control" id="level" placeholder="例如：50">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">总资产(m) *</label>
                        <input type="number" step="0.01" class="form-control" id="totalAssets" required placeholder="例如：200.50">
                        <small style="color: #999;">必须大于纯币资产</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">纯币资产(m) *</label>
                        <input type="number" step="0.01" class="form-control" id="pureCoinAssets" required placeholder="例如：150.00" onchange="calculatePrice()">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">体力等级</label>
                        <input type="number" class="form-control" id="staminaLevel" placeholder="例如：30">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">保险箱格数 *</label>
                        <select class="form-control" id="safeBoxSlots" required onchange="calculatePrice()">
                            <option value="">请选择</option>
                            <option value="4">4格 (比例42)</option>
                            <option value="6">6格 (比例40)</option>
                            <option value="9">9格 (比例38)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">AW子弹</label>
                    <input type="number" class="form-control" id="awBullets" placeholder="例如：500">
                </div>
                
                <div class="form-group">
                    <label class="form-label">持有刀皮（可多选）</label>
                    <select class="form-control" id="knifeSkins" multiple style="height: 120px;">
                        <option value="北极星">北极星</option>
                        <option value="黑海">黑海</option>
                        <option value="赤霄怜悯">赤霄怜悯</option>
                        <option value="影锋">影锋</option>
                        <option value="信条">信条</option>
                    </select>
                    <small style="color: #999;">按住Ctrl键可多选</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">租金 (自动计算)</label>
                        <input type="number" step="0.01" class="form-control" id="price" readonly placeholder="纯币 × 100 ÷ 比例">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">押金 (自动计算)</label>
                        <input type="number" step="0.01" class="form-control" id="deposit" readonly placeholder="租金 × 30">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea class="form-control" id="remarks" rows="3" placeholder="其他说明信息"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">取消</button>
                    <button type="submit" class="btn btn-primary" style="margin-left: 15px;">发布</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/js/common.js"></script>
    <script>
        let selectedRegion = null;
        
        // 检查登录状态
        checkLogin();
        
        // 区服选择
        function selectRegion(region) {
            selectedRegion = region;
            document.getElementById('serverRegion').value = region === 'qq' ? 'QQ' : '微信';
            
            // 更新按钮样式
            document.getElementById('qqBtn').classList.remove('active');
            document.getElementById('wechatBtn').classList.remove('active');
            
            if (region === 'qq') {
                document.getElementById('qqBtn').classList.add('active');
            } else {
                document.getElementById('wechatBtn').classList.add('active');
            }
        }
        
        // 计算租金和押金
        function calculatePrice() {
            const pureCoin = parseFloat(document.getElementById('pureCoinAssets').value) || 0;
            const safeBoxSlots = parseInt(document.getElementById('safeBoxSlots').value) || 0;
            
            if (pureCoin <= 0 || safeBoxSlots === 0) {
                document.getElementById('price').value = '';
                document.getElementById('deposit').value = '';
                return;
            }
            
            // 计算比例
            const ratioMap = { 4: 42, 6: 40, 9: 38 };
            const ratio = ratioMap[safeBoxSlots] || 40;
            
            // 租金 = 纯币 × 100 ÷ 比例
            const rental = pureCoin * 100 / ratio;
            
            // 押金 = 租金 × 30
            const deposit = rental * 30;
            
            document.getElementById('price').value = rental.toFixed(2);
            document.getElementById('deposit').value = deposit.toFixed(2);
        }
        
        document.getElementById('publishForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 验证区服选择
            if (!selectedRegion) {
                showMessage('请选择区服（QQ或微信）', 'error');
                return;
            }
            
            // 验证总资产 > 纯币资产
            const totalAssets = parseFloat(document.getElementById('totalAssets').value);
            const pureCoin = parseFloat(document.getElementById('pureCoinAssets').value);
            
            if (totalAssets <= pureCoin) {
                showMessage('总资产必须大于纯币资产', 'error');
                return;
            }
            
            // 获取刀皮选择
            const knifeSkinSelect = document.getElementById('knifeSkins');
            const knifeSkins = Array.from(knifeSkinSelect.selectedOptions).map(opt => opt.value);
            
            const formData = {
                // account_number 由后端自动生成，不需要前端提供
                collection_time: document.getElementById('collectionTime').value || null,
                login_time: document.getElementById('loginTime').value || null,
                common_location: document.getElementById('commonLocation').value || null,
                server_region: document.getElementById('serverRegion').value,
                login_method: document.getElementById('loginMethod').value || null,
                face_verification: document.getElementById('faceVerification').value || null,
                rank: document.getElementById('rank').value || null,
                total_assets: parseFloat(document.getElementById('totalAssets').value),
                pure_coin_assets: parseFloat(document.getElementById('pureCoinAssets').value),
                level: parseInt(document.getElementById('level').value) || null,
                stamina_level: parseInt(document.getElementById('staminaLevel').value) || null,
                safe_box_slots: parseInt(document.getElementById('safeBoxSlots').value),
                aw_bullets: parseInt(document.getElementById('awBullets').value) || null,
                knife_skins: knifeSkins,
                price: parseFloat(document.getElementById('price').value),
                deposit: parseFloat(document.getElementById('deposit').value),
                remarks: document.getElementById('remarks').value || null
            };
            
            try {
                const data = await apiRequest('/accounts/', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (data.success) {
                    showMessage('发布成功！', 'success');
                    setTimeout(() => {
                        window.location.href = '/profile';
                    }, 1500);
                } else {
                    showMessage(data.message || '发布失败', 'error');
                }
            } catch (error) {
                showMessage('发布失败: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
