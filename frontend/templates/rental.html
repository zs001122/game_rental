<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·ç§Ÿèµ - æ¸¸æˆè´¦å·ç§Ÿèµå¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">æ¸¸æˆè´¦å·ç§Ÿèµå¹³å°</a>
            <ul class="navbar-menu">
                <li><a href="/rental">è´¦å·ç§Ÿèµ</a></li>
                <li><a href="/publish">å‘å¸ƒè´¦å·</a></li>
                <li><a href="/activity">å‡ºå¸æ´»åŠ¨</a></li>
                <li><a href="/profile">ä¸ªäººä¸­å¿ƒ</a></li>
            </ul>
            <div class="navbar-user"></div>
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <!-- æ˜Ÿç©ºå•†åŸæ¨ªå¹… -->
        <div class="starry-mall-banner">
            <div class="banner-bg-image"></div>
            <div class="banner-content">
                <div class="banner-left">
                    <div class="banner-icon">ğŸŒŒ</div>
                    <div class="banner-title">
                        <div>æ˜Ÿç©º</div>
                        <div>å•†åŸŸ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨è£…é¥°å’Œæœç´¢åŒºåŸŸ -->
        <div class="rental-header">
            <div class="header-left">
                <div class="header-image">ğŸ®</div>
                <h2 class="header-title">æ˜Ÿç©ºå•†è¡Œæ¬¢è¿ä½ </h2>
            </div>
            <div class="header-right">
                <div class="header-image">âœ¨</div>
                <button class="btn btn-primary" id="toggleFilterBtn" onclick="toggleFilter()">ğŸ” æœç´¢</button>
            </div>
        </div>
        
        <!-- ç­›é€‰åŒºåŸŸï¼ˆå¯éšè—ï¼‰ -->
        <div class="filter-section" id="filterSection" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #ffd700;">é«˜çº§ç­›é€‰</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label class="form-label">ä¿é™©ç®±æ ¼æ•°</label>
                    <select class="form-control" id="filterSafeBox" multiple>
                        <option value="4">4æ ¼</option>
                        <option value="6">6æ ¼</option>
                        <option value="9">9æ ¼</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœ€å°ç­‰çº§</label>
                    <input type="number" class="form-control" id="filterMinLevel" placeholder="ä¾‹å¦‚ï¼š45">
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœ€å¤§ç­‰çº§</label>
                    <input type="number" class="form-control" id="filterMaxLevel" placeholder="ä¾‹å¦‚ï¼š100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">åŒºæœ</label>
                    <input type="text" class="form-control" id="filterRegion" placeholder="ä¾‹å¦‚ï¼šåä¸œ">
                </div>
            </div>
            
            <div class="filter-row">
                <div class="form-group">
                    <label class="form-label">åˆ€çš®</label>
                    <select class="form-control" id="filterKnifeSkins" multiple>
                        <option value="åŒ—ææ˜Ÿ">åŒ—ææ˜Ÿ</option>
                        <option value="é»‘æµ·">é»‘æµ·</option>
                        <option value="èµ¤éœ„æ€œæ‚¯">èµ¤éœ„æ€œæ‚¯</option>
                        <option value="å½±é”‹">å½±é”‹</option>
                        <option value="ä¿¡æ¡">ä¿¡æ¡</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœ€å°èµ„äº§</label>
                    <input type="number" class="form-control" id="filterMinAssets" placeholder="ä¾‹å¦‚ï¼š100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœ€å¤§èµ„äº§</label>
                    <input type="number" class="form-control" id="filterMaxAssets" placeholder="ä¾‹å¦‚ï¼š500">
                </div>
            </div>
            
            <div style="text-align: right;">
                <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                <button class="btn btn-primary" onclick="loadAccounts()">æœç´¢</button>
            </div>
        </div>
        
        <!-- è´¦å·åˆ—è¡¨ -->
        <div id="accountList" class="account-grid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <script src="/static/js/common.js"></script>
    <script>
        let currentUser = null;
        let filterVisible = false;
        
        // åˆ‡æ¢æœç´¢æ æ˜¾ç¤º/éšè—
        function toggleFilter() {
            const filterSection = document.getElementById('filterSection');
            const toggleBtn = document.getElementById('toggleFilterBtn');
            filterVisible = !filterVisible;
            
            if (filterVisible) {
                filterSection.style.display = 'block';
                toggleBtn.textContent = 'ğŸ” éšè—æœç´¢';
            } else {
                filterSection.style.display = 'none';
                toggleBtn.textContent = 'ğŸ” æœç´¢';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function init() {
            currentUser = await checkLogin();
            if (currentUser) {
                loadAccounts();
            }
        }
        
        // åŠ è½½è´¦å·åˆ—è¡¨
        async function loadAccounts() {
            const accountList = document.getElementById('accountList');
            accountList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                // è·å–ç­›é€‰æ¡ä»¶
                const params = new URLSearchParams();
                
                const safeBoxSelect = document.getElementById('filterSafeBox');
                const selectedSafeBox = Array.from(safeBoxSelect.selectedOptions).map(opt => opt.value);
                selectedSafeBox.forEach(val => params.append('safe_box_slots', val));
                
                const minLevel = document.getElementById('filterMinLevel').value;
                if (minLevel) params.append('min_level', minLevel);
                
                const maxLevel = document.getElementById('filterMaxLevel').value;
                if (maxLevel) params.append('max_level', maxLevel);
                
                const region = document.getElementById('filterRegion').value;
                if (region) params.append('server_region', region);
                
                const knifeSkinSelect = document.getElementById('filterKnifeSkins');
                const selectedKnifeSkins = Array.from(knifeSkinSelect.selectedOptions).map(opt => opt.value);
                selectedKnifeSkins.forEach(val => params.append('knife_skins', val));
                
                const minAssets = document.getElementById('filterMinAssets').value;
                if (minAssets) params.append('min_assets', minAssets);
                
                const maxAssets = document.getElementById('filterMaxAssets').value;
                if (maxAssets) params.append('max_assets', maxAssets);
                
                const data = await apiRequest('/accounts?' + params.toString());
                
                if (data.accounts.length === 0) {
                    accountList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æš‚æ— ç¬¦åˆæ¡ä»¶çš„è´¦å·</p></div>';
                    return;
                }
                
                accountList.innerHTML = data.accounts.map(account => `
                    <div class="account-card">
                        <div class="account-header">
                            <span class="account-number">${account.account_number}</span>
                            <span class="account-status ${getStatusClass(account.status)}">${getStatusText(account.status)}</span>
                        </div>
                        
                        <div class="account-info">
                            <div class="info-item">
                                <span class="info-label">åŒºæœ:</span>
                                <span class="info-value">${account.server_region || '-'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ç­‰çº§:</span>
                                <span class="info-value">${account.level || '-'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ®µä½:</span>
                                <span class="info-value">${account.rank || '-'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ä¿é™©ç®±:</span>
                                <span class="info-value">${account.safe_box_slots}æ ¼</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">çº¯å¸èµ„äº§:</span>
                                <span class="info-value">${formatMoney(account.pure_coin_assets)}m</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ€»èµ„äº§:</span>
                                <span class="info-value">${account.total_assets ? formatMoney(account.total_assets) + 'm' : '-'}</span>
                            </div>
                        </div>
                        
                        <div class="knife-skins" style="min-height: 60px; margin: 10px 0;">
                            ${account.knife_skins && account.knife_skins.length > 0 ? `
                                <div style="color: #666; font-size: 12px; margin-bottom: 5px;">æŒæœ‰åˆ€çš®:</div>
                                ${account.knife_skins.map(skin => `<span class="knife-tag">${skin}</span>`).join('')}
                            ` : ''}
                        </div>
                        
                        <div style="font-size: 12px; color: #666; margin-top: 5px; margin-bottom: 15px; min-height: 36px; line-height: 18px;">
                            ${account.remarks ? `å¤‡æ³¨: ${account.remarks}` : ''}
                        </div>
                        
                        <div class="account-footer">
                            <div class="price-info">
                                <span class="price-label">ç§Ÿé‡‘:</span>
                                <span class="price-value">Â¥${formatMoney(account.order_amount)}</span>
                                <span style="font-size: 12px; color: #999; margin-left: 10px;">æŠ¼é‡‘: Â¥${formatMoney(account.deposit)}</span>
                            </div>
                            ${account.status === 'available' ? `
                                <button class="btn btn-primary" onclick="rentAccount(${account.id})">ç§Ÿèµ</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                accountList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
            }
        }
        
        // ç§Ÿèµè´¦å·
        async function rentAccount(accountId) {
            if (!confirm('ç¡®è®¤ç§Ÿèµæ­¤è´¦å·å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const data = await apiRequest('/orders/', {
                    method: 'POST',
                    body: JSON.stringify({ account_id: accountId })
                });
                
                if (data.success) {
                    if (confirm('è®¢å•åˆ›å»ºæˆåŠŸï¼æ˜¯å¦ç«‹å³æ”¯ä»˜ï¼Ÿ')) {
                        await payOrder(data.order.id);
                    } else {
                        showMessage('è®¢å•å·²åˆ›å»ºï¼Œè¯·å‰å¾€ä¸ªäººä¸­å¿ƒæ”¯ä»˜', 'success');
                        loadAccounts();
                    }
                }
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }
        
        // æ”¯ä»˜è®¢å•
        async function payOrder(orderId) {
            try {
                const data = await apiRequest(`/orders/${orderId}/pay`, {
                    method: 'POST'
                });
                
                if (data.success) {
                    showMessage('æ”¯ä»˜æˆåŠŸï¼', 'success');
                    await updateNavbar();
                    loadAccounts();
                }
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }
        
        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('filterSafeBox').selectedIndex = -1;
            document.getElementById('filterMinLevel').value = '';
            document.getElementById('filterMaxLevel').value = '';
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterKnifeSkins').selectedIndex = -1;
            document.getElementById('filterMinAssets').value = '';
            document.getElementById('filterMaxAssets').value = '';
            loadAccounts();
        }
        
        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
