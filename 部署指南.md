# 部署指南

本文档介绍如何将游戏账号租赁平台部署到生产环境。

## 环境要求

- Python 3.8+
- 操作系统：Linux / macOS / Windows
- 内存：至少512MB
- 磁盘空间：至少100MB

## 部署步骤

### 1. 下载项目

将项目文件上传到服务器，或使用Git克隆项目。

```bash
# 解压项目压缩包
tar -xzf game_rental_platform.tar.gz
cd game_rental_platform
```

### 2. 安装Python依赖

```bash
pip3 install -r requirements.txt
```

### 3. 配置数据库

项目默认使用SQLite数据库，数据库文件位于 `game_rental.db`。

如需使用MySQL数据库，请修改 `backend/config.py` 文件：

```python
# 修改前（SQLite）
SQLALCHEMY_DATABASE_URI = f'sqlite:///{DATABASE_PATH}'

# 修改后（MySQL）
SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://用户名:密码@主机:端口/数据库名?charset=utf8mb4'
```

### 4. 初始化数据库

```bash
# 生成模拟数据（可选）
python3 generate_mock_data.py
```

### 5. 配置环境变量

建议在生产环境中设置以下环境变量：

```bash
export SECRET_KEY="your-secret-key-here"
export FLASK_ENV="production"
```

### 6. 启动应用

#### 开发环境

```bash
python3 run.py
```

#### 生产环境（使用Gunicorn）

首先安装Gunicorn：

```bash
pip3 install gunicorn
```

然后启动应用：

```bash
gunicorn -w 4 -b 0.0.0.0:5000 "backend.app:create_app()"
```

参数说明：
- `-w 4`: 使用4个工作进程
- `-b 0.0.0.0:5000`: 绑定到所有网络接口的5000端口

### 7. 配置反向代理（推荐）

使用Nginx作为反向代理可以提高性能和安全性。

#### 安装Nginx

```bash
sudo apt-get update
sudo apt-get install nginx
```

#### 配置Nginx

创建配置文件 `/etc/nginx/sites-available/game_rental`:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static {
        alias /path/to/game_rental_platform/frontend/static;
        expires 30d;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/game_rental /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 8. 配置系统服务（可选）

创建systemd服务文件 `/etc/systemd/system/game_rental.service`:

```ini
[Unit]
Description=Game Rental Platform
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/path/to/game_rental_platform
Environment="PATH=/usr/bin"
ExecStart=/usr/bin/gunicorn -w 4 -b 127.0.0.1:5000 "backend.app:create_app()"
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start game_rental
sudo systemctl enable game_rental
sudo systemctl status game_rental
```

## 安全建议

1. **修改默认密钥**
   - 在 `backend/config.py` 中修改 `SECRET_KEY`

2. **使用HTTPS**
   - 使用Let's Encrypt申请免费SSL证书
   - 配置Nginx支持HTTPS

3. **限制数据库访问**
   - 如使用MySQL，确保数据库只允许本地访问
   - 使用强密码

4. **定期备份**
   - 定期备份数据库文件
   - 备份用户上传的文件

5. **监控日志**
   - 定期检查应用日志
   - 监控异常访问

## 性能优化

1. **使用缓存**
   - 考虑使用Redis缓存热门数据

2. **数据库优化**
   - 为常用查询字段添加索引
   - 定期清理过期数据

3. **静态资源CDN**
   - 将CSS、JS等静态资源部署到CDN

4. **负载均衡**
   - 使用多个应用实例
   - 配置Nginx负载均衡

## 故障排查

### 应用无法启动

1. 检查Python版本是否符合要求
2. 确认所有依赖已正确安装
3. 查看错误日志

### 数据库连接失败

1. 检查数据库配置是否正确
2. 确认数据库服务已启动
3. 检查防火墙设置

### 页面无法访问

1. 检查应用是否正常运行
2. 确认端口未被占用
3. 检查Nginx配置

## 维护建议

1. **定期更新**
   - 定期更新Python依赖包
   - 关注安全漏洞

2. **数据备份**
   - 每天自动备份数据库
   - 保留至少7天的备份

3. **监控告警**
   - 配置服务监控
   - 设置异常告警

4. **日志管理**
   - 定期清理旧日志
   - 分析访问日志

## 联系支持

如遇到问题，请参考项目README文档或联系开发团队。
